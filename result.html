<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>문제 결과</title>
  <style>
   </style>
</head>
<body>
  <div class="page-container">
    <div class="page" id="questions"></div>
    <div class="page-break"></div>
    <div class="page" id="answers"></div>
    <div class="page-break"></div>
    <div class="page" id="explanations"></div>
  </div>

  <script type="module">
    const typeMap = {
      주장: { file: 'clm', fn: 'generateClaimQuestion' },
      요지: { file: 'mni', fn: 'generateMniQuestion' },
      주제: { file: 'top', fn: 'generateTopQuestion' },
      제목: { file: 'tit', fn: 'generateTitQuestion' },
      요약: { file: 'sum', fn: 'generateSumQuestion' },
      불일치: { file: 'mis', fn: 'generateMisQuestion' },
      흐름: { file: 'flo', fn: 'generateFloQuestion' },
      순서: { file: 'ord', fn: 'generateOrdQuestion' },
      삽입: { file: 'ins', fn: 'generateInsQuestion' },
      빈칸: { file: 'bln', fn: 'generateBlnQuestion' },
      어법: { file: 'grm', fn: 'generateGrmQuestion' },
      어휘: { file: 'voc', fn: 'generateVocQuestion' },
      '어휘(상)': { file: 'voca', fn: 'generateVocaQuestion' },
      함축의미: { file: 'imp', fn: 'generateImpQuestion' }
    };

    const types = JSON.parse(localStorage.getItem('types') || '[]');
    const passage = localStorage.getItem('passage') || '';
    const withExplanation = localStorage.getItem('withExplanation') === 'true';
    const mobileOutput = localStorage.getItem('mobileOutput') === 'true';

    if (!mobileOutput) {
      const vp = document.querySelector('meta[name="viewport"]');
      if (vp) vp.remove();
    }

    const questionsContainer = document.getElementById('questions');
    const answersContainer = document.getElementById('answers');
    const explanationsContainer = document.getElementById('explanations');

    async function loadAll() {
      const questionsData = [];

      console.log('[디버그] types:', types);

      if (!types || types.length === 0) {
        console.warn('[경고] types 배열이 비어 있음. 문제 생성 요청을 생략합니다.');
      }

      for (const type of types) {
        const map = typeMap[type];
        if (!map) {
          console.warn(`[경고] typeMap에 '${type}' 없음`);
          continue;
        }

        try {
          console.log(`[요청] /api/${map.file} (유형: ${type})`);
          const response = await fetch(`/api/${map.file}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ passage })
          });

          if (!response.ok) {
            console.error(`[에러] ${type} 요청 실패 (status: ${response.status})`);
            continue;
          }

          const q = await response.json();
          console.log(`[성공] ${type} 응답:`, q);

          if (!q.prompt || !q.body) {
            console.warn(`[경고] ${type} 응답에 prompt 또는 body 누락됨`);
          }

          questionsData.push(q);

        } catch (e) {
          console.error(`[예외] ${type} 문항 로드 중 오류:`, e);
        }
      }

      console.log('[디버그] 최종 questionsData:', questionsData);

      questionsContainer.innerHTML = questionsData.map((q, i) => `
        <div class="question-item">
          <strong>${i + 1}. ${q.prompt}</strong>
          ${q.body}
        </div>
      `).join('');

      answersContainer.innerHTML = questionsData.map((q, i) => `
        <div class="question-item">
          <strong>${i + 1}번 정답:</strong> ${q.answer}
        </div>
      `).join('');

      if (withExplanation) {
        explanationsContainer.innerHTML = questionsData.map((q, i) => `
          <div class="question-item">
            <strong>${i + 1}번 해설:</strong> ${q.explanation}
          </div>
        `).join('');
      }

      console.log('[디버그] mobileOutput:', mobileOutput);
      document.body.classList.toggle('paper', !mobileOutput);
    }

    loadAll().then(() => {
      document.body.classList.toggle('paper', !mobileOutput);
    });
  </script>
</body>
</html>
